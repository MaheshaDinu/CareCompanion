<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareCompanion - Medication Schedule Management</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap Datepicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <!-- Bootstrap Timepicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-timepicker/0.5.2/css/bootstrap-timepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-timepicker/0.5.2/js/bootstrap-timepicker.min.js"></script>

    <style>
        :root {
            --primary: #4895ef;
            --primary-light: rgba(72, 149, 239, 0.1);
            --primary-dark: #3a75c4;
            --secondary: #3a0ca3;
            --success: #06d6a0;
            --success-light: rgba(6, 214, 160, 0.1);
            --light-bg: #f8f9fa;
            --text-dark: #2d3436;
            --danger: #ef476f;
            --danger-light: rgba(239, 71, 111, 0.1);
            --warning: #ffd166;
            --warning-light: rgba(255, 209, 102, 0.1);
            --gray: #adb5bd;
            --gray-light: #e9ecef;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system;
            background-color: var(--light-bg);
            color: var(--text-dark);
        }

        .card {
            background: white;
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.08);
        }

        .nav-pills .nav-link {
            border-radius: 8px;
            color: var(--text-dark);
            transition: all 0.2s ease;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .nav-pills .nav-link:hover {
            background-color: var(--primary-light);
        }

        .nav-pills .nav-link.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 8px rgba(72, 149, 239, 0.2);
        }

        .nav-pills .nav-link i {
            margin-right: 0.75rem;
        }

        .navbar {
            padding: 0.75rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .navbar-brand {
            font-size: 1.4rem;
        }

        .sidebar {
            height: calc(100vh - 70px);
            position: sticky;
            top: 70px;
            padding: 1.5rem;
            overflow-y: auto;
            transition: width 0.3s ease;
        }

        .main-content {
            padding: 1.5rem;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.25rem var(--primary-light);
        }

        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn-outline-primary {
            color: var(--primary);
            border-color: var(--primary);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .table-responsive {
            border-radius: 12px;
            overflow: hidden;
        }

        .table {
            margin-bottom: 0;
        }

        .table th {
            font-weight: 600;
            color: var(--text-dark);
        }

        .table td {
            vertical-align: middle;
        }

        .badge-pill {
            padding: 0.35rem 0.75rem;
            border-radius: 50px;
            font-weight: 500;
            font-size: 0.75rem;
        }

        .badge-daily {
            background-color: var(--primary-light);
            color: var(--primary);
        }

        .badge-twice {
            background-color: var(--warning-light);
            color: var(--warning);
        }

        .badge-weekly {
            background-color: var(--success-light);
            color: var(--success);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 18px;
            height: 18px;
            background-color: var(--danger);
            color: white;
            border-radius: 50%;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-header {
            margin-bottom: 1.5rem;
        }

        .page-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--gray);
            margin-bottom: 0;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 10;
            border-radius: 12px;
        }

        .loading-spinner .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--primary);
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .patient-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .patient-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .patient-card.active {
            border: 2px solid var(--primary);
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        .patient-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .patient-avatar i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .medication-card {
            border-left: 4px solid var(--primary);
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }

        .medication-card:hover {
            transform: translateX(3px);
        }

        .medication-card.daily {
            border-left-color: var(--primary);
        }

        .medication-card.twice {
            border-left-color: var(--warning);
        }

        .medication-card.weekly {
            border-left-color: var(--success);
        }

        .medication-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .medication-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0;
        }

        .medication-dosage {
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .medication-schedule {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .medication-schedule i {
            margin-right: 0.5rem;
            color: var(--gray);
        }

        .medication-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-container i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .search-input {
            padding-left: 2.5rem;
            border-radius: 50px;
        }

        .filter-dropdown {
            margin-bottom: 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--gray-light);
            margin-bottom: 1rem;
        }

        .empty-state h5 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--gray);
            margin-bottom: 1.5rem;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .sidebar {
                height: auto;
                position: relative;
                top: 0;
            }

            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg bg-white shadow-sm sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-primary" href="#">
            <i class="bi bi-heart-pulse me-2"></i>CareCompanion
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-plus-circle me-1"></i> New
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addMedicationModal"><i class="bi bi-capsule me-2"></i>Medication</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-calendar-plus me-2"></i>Appointment</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-person-plus me-2"></i>Patient</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-plus me-2"></i>Prescription</a></li>
                    </ul>
                </li>
                <li class="nav-item position-relative me-3">
                    <a class="nav-link" href="#">
                        <i class="bi bi-bell fs-5"></i>
                        <span class="notification-badge">3</span>
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="rounded-circle bg-primary-light d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                            <i class="bi bi-person-fill text-primary"></i>
                        </div>
                        <span id="provider_name">Dr. Sarah Johnson</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-2 bg-white sidebar">
            <nav class="nav nav-pills flex-column">
                <a class="nav-link" href="provider-dashboard.html">
                    <i class="bi bi-speedometer2"></i>Dashboard
                </a>
                <a class="nav-link" href="provider-appointments.html">
                    <i class="bi bi-calendar-check"></i>Appointments
                </a>
                <a class="nav-link" href="#">
                    <i class="bi bi-calendar-week"></i>Schedule
                </a>
                <a class="nav-link" href="#">
                    <i class="bi bi-people"></i>Patients
                </a>
                <a class="nav-link active" href="provider-medication-schedule.html">
                    <i class="bi bi-capsule"></i>Medications
                </a>
                <a class="nav-link" href="#">
                    <i class="bi bi-heart-pulse"></i>Health Data
                </a>
                <a class="nav-link" href="#">
                    <i class="bi bi-file-earmark-text"></i>Reports
                </a>
                <a class="nav-link" href="#">
                    <i class="bi bi-chat-left-dots"></i>Messages
                </a>
                <a class="nav-link" href="#">
                    <i class="bi bi-gear"></i>Settings
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="col-lg-10 main-content">
            <div class="page-header d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="page-title">Medication Schedule Management</h1>
                    <p class="page-subtitle">Manage medication schedules for your patients</p>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicationModal">
                        <i class="bi bi-plus-circle me-1"></i> Add Medication
                    </button>
                </div>
            </div>

            <div class="row g-4">
                <!-- Patient List -->
                <div class="col-lg-4">
                    <div class="card mb-4">
                        <div class="card-header bg-white py-3">
                            <h5 class="mb-0">Patients</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="search-container p-3">
                                <i class="bi bi-search"></i>
                                <input type="text" class="form-control search-input" id="patientSearch" placeholder="Search patients...">
                            </div>
                            <div class="list-group list-group-flush" id="patientList">
                                <!-- Patient list will be populated here -->
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Medication Schedule -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0" id="medicationPatientName">Select a patient</h5>
                            <div class="dropdown filter-dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-funnel me-1"></i> Filter
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                                    <li><a class="dropdown-item" href="#" data-filter="all">All Medications</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="DAILY">Daily</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="TWICE_A_DAY">Twice a Day</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="WEEKLY">Weekly</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" data-filter="active">Active</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="upcoming">Upcoming</a></li>
                                    <li><a class="dropdown-item" href="#" data-filter="expired">Expired</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body" id="medicationScheduleContainer">
                            <!-- Empty state -->
                            <div class="empty-state" id="emptyState">
                                <i class="bi bi-capsule"></i>
                                <h5>No Patient Selected</h5>
                                <p>Please select a patient from the list to view their medication schedules.</p>
                            </div>

                            <!-- Medication list will be populated here -->
                            <div id="medicationList" class="d-none">
                                <!-- Medications will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Medication Modal -->
<div class="modal fade" id="addMedicationModal" tabindex="-1" aria-labelledby="addMedicationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMedicationModalLabel">Add New Medication</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addMedicationForm">
                    <div class="mb-3">
                        <label for="patientSelect" class="form-label">Patient</label>
                        <select class="form-select" id="patientSelect" required>
                            <option value="" selected disabled>Select a patient</option>
                            <!-- Patient options will be populated here -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="medicationName" class="form-label">Medication Name</label>
                        <input type="text" class="form-control" id="medicationName" placeholder="Enter medication name" required>
                    </div>
                    <div class="mb-3">
                        <label for="dosage" class="form-label">Dosage</label>
                        <input type="text" class="form-control" id="dosage" placeholder="e.g., 10mg, 1 tablet" required>
                    </div>
                    <div class="mb-3">
                        <label for="frequency" class="form-label">Frequency</label>
                        <select class="form-select" id="frequency" required>
                            <option value="" selected disabled>Select frequency</option>
                            <option value="DAILY">Daily</option>
                            <option value="TWICE_A_DAY">Twice a Day</option>
                            <option value="WEEKLY">Weekly</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="reminderTime" class="form-label">Reminder Time</label>
                        <input type="time" class="form-control" id="reminderTime" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMedicationBtn">Save Medication</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Medication Modal -->
<div class="modal fade" id="editMedicationModal" tabindex="-1" aria-labelledby="editMedicationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMedicationModalLabel">Edit Medication</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editMedicationForm">
                    <input type="hidden" id="editMedicationId">
                    <div class="mb-3">
                        <label for="editMedicationName" class="form-label">Medication Name</label>
                        <input type="text" class="form-control" id="editMedicationName" placeholder="Enter medication name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDosage" class="form-label">Dosage</label>
                        <input type="text" class="form-control" id="editDosage" placeholder="e.g., 10mg, 1 tablet" required>
                    </div>
                    <div class="mb-3">
                        <label for="editFrequency" class="form-label">Frequency</label>
                        <select class="form-select" id="editFrequency" required>
                            <option value="" selected disabled>Select frequency</option>
                            <option value="DAILY">Daily</option>
                            <option value="TWICE_A_DAY">Twice a Day</option>
                            <option value="WEEKLY">Weekly</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editStartDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="editStartDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editEndDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="editEndDate" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editReminderTime" class="form-label">Reminder Time</label>
                        <input type="time" class="form-control" id="editReminderTime" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateMedicationBtn">Update Medication</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteMedicationModal" tabindex="-1" aria-labelledby="deleteMedicationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteMedicationModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this medication schedule? This action cannot be undone.</p>
                <input type="hidden" id="deleteMedicationId">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="deleteMedicationName"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div class="toast-container">
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" id="notificationToast">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Operation completed successfully.
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JavaScript -->
<script>
    $(document).ready(function() {
        // Current provider ID (would normally come from session/auth)
        let currentProviderId = 1;
        let selectedPatientId = null;
        let currentFilter = 'all';
        const providerName = document.getElementById("provider_name");
        loadProviderDetails()

        function loadProviderDetails() {
            $.ajax({
                url:"http://localhost:8080/provider/medication-schedule/getProvider",
                type:"GET",
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("jwtToken")
                },
                success: function(response) {
                    if (response.code === 200) {
                        const provider = response.data;
                        providerName.textContent = "Dr. " + provider.firstName + " " + provider.lastName;
                        currentProviderId = provider.id;
                    } else {
                        showError(response.message)
                    }
                }

            })
        }


        // Initialize the page
        loadPatients();

        // Search functionality for patients
        $('#patientSearch').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('.patient-item').each(function() {
                const patientName = $(this).find('.patient-name').text().toLowerCase();
                if (patientName.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Filter functionality for medications
        $('.dropdown-item[data-filter]').on('click', function(e) {
            e.preventDefault();
            currentFilter = $(this).data('filter');
            $('#filterDropdown').text($(this).text());
            if (selectedPatientId) {
                loadMedicationSchedules(selectedPatientId);
            }
        });

        // Handle patient selection
        $(document).on('click', '.patient-item', function() {
            $('.patient-item').removeClass('active');
            $(this).addClass('active');
            selectedPatientId = $(this).data('id');
            const patientName = $(this).find('.patient-name').text();
            $('#medicationPatientName').text(`${patientName}'s Medications`);

            // Show medication list and hide empty state
            $('#emptyState').addClass('d-none');
            $('#medicationList').removeClass('d-none');

            // Load medication schedules for the selected patient
            loadMedicationSchedules(selectedPatientId);
        });

        // Save new medication
        console.log('…binding save btn…');
        $('#saveMedicationBtn').on('click', function() {
            console.log('Save button clicked!');
            if (!validateMedicationForm('add')) {
                console.log("returned");
                return;}

            const medicationData = {
                patientId: $('#patientSelect').val(),
                medicationName: $('#medicationName').val(),
                dosage: $('#dosage').val(),
                frequency: $('#frequency').val(),
                startDate: $('#startDate').val(),
                endDate: $('#endDate').val(),
                reminderTime: $('#reminderTime').val()
            };

            saveMedication(medicationData);
        });

        // Update medication
        $('#updateMedicationBtn').on('click', function() {
            if (!validateMedicationForm('edit')) return;

            const medicationData = {
                id: $('#editMedicationId').val(),
                patientId: selectedPatientId,
                medicationName: $('#editMedicationName').val(),
                dosage: $('#editDosage').val(),
                frequency: $('#editFrequency').val(),
                startDate: $('#editStartDate').val(),
                endDate: $('#editEndDate').val(),
                reminderTime: $('#editReminderTime').val()
            };

            updateMedication(medicationData);
        });

        // Confirm delete medication
        $('#confirmDeleteBtn').on('click', function() {
            const medicationId = $('#deleteMedicationId').val();
            deleteMedication(medicationId);
        });

        // Handle edit medication button click
        $(document).on('click', '.edit-medication', function(e) {
            e.stopPropagation();
            const medicationId = $(this).data('id');
            getMedicationDetails(medicationId);
        });

        // Handle delete medication button click
        $(document).on('click', '.delete-medication', function(e) {
            e.stopPropagation();
            const medicationId = $(this).data('id');
            const medicationName = $(this).closest('.medication-card').find('.medication-name').text();

            $('#deleteMedicationId').val(medicationId);
            $('#deleteMedicationName').text(medicationName);
            $('#deleteMedicationModal').modal('show');
        });

        // Function to load patients
        function loadPatients() {
            $.ajax({
                url: `http://localhost:8080/provider/medication-schedule/getPatients`,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("jwtToken")
                },
                success: function(response) {
                    const patients = response.data || [];
                    renderPatientList(patients);
                    populatePatientSelect(patients);
                },
                error: function(xhr, status, error) {
                    console.error('Error loading patients:', error);
                    showToast('Error', 'Failed to load patients. Please try again.', 'error');

                    // For demo purposes, load sample data
                    const samplePatients = getSamplePatients();
                    renderPatientList(samplePatients);
                    populatePatientSelect(samplePatients);
                }
            });
        }

        // Function to render patient list
        function renderPatientList(patients) {
            const patientList = $('#patientList');
            patientList.empty();

            if (patients.length === 0) {
                patientList.html('<div class="text-center py-4">No patients found</div>');
                return;
            }

            patients.forEach(patient => {
                const patientItem = `
                <div class="list-group-item list-group-item-action patient-item" data-id="${patient.id}">
                    <div class="d-flex align-items-center">
                        <div class="patient-avatar">
                            <i class="bi bi-person"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 patient-name">${patient.firstName} ${patient.lastName}</h6>
                            <small class="text-muted">${patient.age} years • ${patient.gender}</small>
                        </div>
                    </div>
                </div>
            `;
                patientList.append(patientItem);
            });
        }

        // Function to populate patient select dropdown
        function populatePatientSelect(patients) {
            const patientSelect = $('#patientSelect');
            patientSelect.find('option:not(:first)').remove();

            patients.forEach(patient => {
                patientSelect.append(`<option value="${patient.id}">${patient.firstName} ${patient.lastName}</option>`);
            });
        }

        // Function to load medication schedules for a patient
        function loadMedicationSchedules(patientId) {
            $.ajax({
                url: `http://localhost:8080/provider/medication-schedule/getMedicationSchedulesByPatient/${patientId}`,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("jwtToken")
                },
                success: function(response) {
                    const medications = response.data || [];
                    renderMedicationSchedules(medications);
                },
                error: function(xhr, status, error) {
                    console.error('Error loading medication schedules:', error);
                    showToast('Error', 'Failed to load medication schedules. Please try again.', 'error');

                    // For demo purposes, load sample data
                    const sampleMedications = getSampleMedications(patientId);
                    renderMedicationSchedules(sampleMedications);
                }
            });
        }

        // Function to render medication schedules
        function renderMedicationSchedules(medications) {
            const medicationList = $('#medicationList');
            medicationList.empty();

            if (medications.length === 0) {
                medicationList.html(`
                <div class="empty-state">
                    <i class="bi bi-capsule"></i>
                    <h5>No Medications Found</h5>
                    <p>This patient doesn't have any medication schedules yet.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicationModal">
                        <i class="bi bi-plus-circle me-1"></i> Add Medication
                    </button>
                </div>
            `);
                return;
            }

            // Filter medications based on current filter
            let filteredMedications = medications;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (currentFilter !== 'all') {
                if (currentFilter === 'active') {
                    filteredMedications = medications.filter(med => {
                        const startDate = new Date(med.startDate);
                        const endDate = new Date(med.endDate);
                        return startDate <= today && endDate >= today;
                    });
                } else if (currentFilter === 'upcoming') {
                    filteredMedications = medications.filter(med => {
                        const startDate = new Date(med.startDate);
                        return startDate > today;
                    });
                } else if (currentFilter === 'expired') {
                    filteredMedications = medications.filter(med => {
                        const endDate = new Date(med.endDate);
                        return endDate < today;
                    });
                } else {
                    // Filter by frequency
                    filteredMedications = medications.filter(med => med.frequency === currentFilter);
                }
            }

            if (filteredMedications.length === 0) {
                medicationList.html(`
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    No medications match the selected filter.
                </div>
            `);
                return;
            }

            filteredMedications.forEach(medication => {
                const startDate = new Date(medication.startDate).toLocaleDateString();
                const endDate = new Date(medication.endDate).toLocaleDateString();

                // Determine medication status
                let status = '';
                const startDateObj = new Date(medication.startDate);
                const endDateObj = new Date(medication.endDate);

                if (startDateObj > today) {
                    status = '<span class="badge bg-info">Upcoming</span>';
                } else if (endDateObj < today) {
                    status = '<span class="badge bg-secondary">Expired</span>';
                } else {
                    status = '<span class="badge bg-success">Active</span>';
                }

                // Determine frequency badge class
                let frequencyClass = '';
                let frequencyBadge = '';

                switch(medication.frequency) {
                    case 'DAILY':
                        frequencyClass = 'daily';
                        frequencyBadge = '<span class="badge badge-daily">Daily</span>';
                        break;
                    case 'TWICE_A_DAY':
                        frequencyClass = 'twice';
                        frequencyBadge = '<span class="badge badge-twice">Twice a Day</span>';
                        break;
                    case 'WEEKLY':
                        frequencyClass = 'weekly';
                        frequencyBadge = '<span class="badge badge-weekly">Weekly</span>';
                        break;
                }

                const medicationCard = `
                <div class="card medication-card ${frequencyClass} mb-3">
                    <div class="card-body">
                        <div class="medication-header">
                            <h5 class="medication-name">${medication.medicationName}</h5>
                            <div>
                                ${frequencyBadge}
                                ${status}
                            </div>
                        </div>
                        <p class="medication-dosage"><strong>Dosage:</strong> ${medication.dosage}</p>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="medication-schedule">
                                    <i class="bi bi-calendar-event"></i>
                                    <span><strong>Start:</strong> ${startDate}</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="medication-schedule">
                                    <i class="bi bi-calendar-x"></i>
                                    <span><strong>End:</strong> ${endDate}</span>
                                </div>
                            </div>
                        </div>
                        <div class="medication-schedule">
                            <i class="bi bi-alarm"></i>
                            <span><strong>Reminder:</strong> ${medication.reminderTime}</span>
                        </div>
                        <hr>
                        <div class="medication-actions">
                            <button class="btn btn-sm btn-outline-primary edit-medication" data-id="${medication.id}">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-medication" data-id="${medication.id}">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;

                medicationList.append(medicationCard);
            });
        }

        // Function to get medication details for editing
        function getMedicationDetails(medicationId) {
            $.ajax({
                url: `http://localhost:8080/provider/medication-schedule/getMedicationSchedule/${medicationId}`,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("jwtToken")
                },
                success: function(response) {
                    const medication = response.data;
                    populateEditForm(medication);
                },
                error: function(xhr, status, error) {
                    console.error('Error getting medication details:', error);
                    showToast('Error', 'Failed to load medication details. Please try again.', 'error');

                    // For demo purposes, get sample medication
                    const sampleMedications = getSampleMedications(selectedPatientId);
                    const medication = sampleMedications.find(med => med.id == medicationId);
                    if (medication) {
                        populateEditForm(medication);
                    }
                }
            });
        }

        // Function to populate edit form
        function populateEditForm(medication) {
            $('#editMedicationId').val(medication.id);
            $('#editMedicationName').val(medication.medicationName);
            $('#editDosage').val(medication.dosage);
            $('#editFrequency').val(medication.frequency);
            $('#editStartDate').val(medication.startDate);
            $('#editEndDate').val(medication.endDate);
            $('#editReminderTime').val(medication.reminderTime);

            $('#editMedicationModal').modal('show');
        }

        // Function to save new medication
        function saveMedication(medicationData) {
            console.log("saving method")
            $.ajax({
                url: 'http://localhost:8080/provider/medication-schedule/addMedicationSchedule',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(medicationData),
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("jwtToken")
                },
                success: function(response) {
                    $('#addMedicationModal').modal('hide');
                    showToast('Success', 'Medication schedule added successfully!', 'success');

                    // If the medication is for the currently selected patient, refresh the list
                    if (selectedPatientId == medicationData.patientId) {
                        loadMedicationSchedules(selectedPatientId);
                    }

                    // Reset form
                    $('#addMedicationForm')[0].reset();
                },
                error: function(xhr, status, error) {
                    console.error('Error saving medication:', error);
                    showToast('Error', 'Failed to save medication schedule. Please try again.', 'error');

                    // For demo purposes, simulate success
                    $('#addMedicationModal').modal('hide');
                    showToast('Success', 'Medication schedule added successfully!', 'success');

                    // If the medication is for the currently selected patient, refresh the list
                    if (selectedPatientId == medicationData.patientId) {
                        // Add the new medication to sample data
                        const sampleMedications = getSampleMedications(selectedPatientId);
                        medicationData.id = Date.now(); // Generate a unique ID
                        sampleMedications.push(medicationData);
                        renderMedicationSchedules(sampleMedications);
                    }

                    // Reset form
                    $('#addMedicationForm')[0].reset();
                }
            });
        }

        // Function to update medication
        function updateMedication(medicationData) {
            $.ajax({
                url: `/api/medication-schedules/${medicationData.id}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(medicationData),
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("jwtToken")
                },
                success: function(response) {
                    $('#editMedicationModal').modal('hide');
                    showToast('Success', 'Medication schedule updated successfully!', 'success');
                    loadMedicationSchedules(selectedPatientId);
                },
                error: function(xhr, status, error) {
                    console.error('Error updating medication:', error);
                    showToast('Error', 'Failed to update medication schedule. Please try again.', 'error');

                    // For demo purposes, simulate success
                    $('#editMedicationModal').modal('hide');
                    showToast('Success', 'Medication schedule updated successfully!', 'success');

                    // Update the medication in sample data
                    const sampleMedications = getSampleMedications(selectedPatientId);
                    const index = sampleMedications.findIndex(med => med.id == medicationData.id);
                    if (index !== -1) {
                        sampleMedications[index] = medicationData;
                    }
                    renderMedicationSchedules(sampleMedications);
                }
            });
        }

        // Function to delete medication
        function deleteMedication(medicationId) {
            $.ajax({
                url: `/api/medication-schedules/${medicationId}`,
                type: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem("jwtToken")
                },
                success: function(response) {
                    $('#deleteMedicationModal').modal('hide');
                    showToast('Success', 'Medication schedule deleted successfully!', 'success');
                    loadMedicationSchedules(selectedPatientId);
                },
                error: function(xhr, status, error) {
                    console.error('Error deleting medication:', error);
                    showToast('Error', 'Failed to delete medication schedule. Please try again.', 'error');

                    // For demo purposes, simulate success
                    $('#deleteMedicationModal').modal('hide');
                    showToast('Success', 'Medication schedule deleted successfully!', 'success');

                    // Remove the medication from sample data
                    const sampleMedications = getSampleMedications(selectedPatientId);
                    const updatedMedications = sampleMedications.filter(med => med.id != medicationId);
                    renderMedicationSchedules(updatedMedications);
                }
            });
        }

        // Function to validate medication form
        function validateMedicationForm(formType) {
            const prefix = formType === 'add' ? '' : 'edit';

            // Check required fields
            const requiredFields = [
                `${prefix}medicationName`,
                `${prefix}dosage`,
                `${prefix}frequency`,
                `${prefix}startDate`,
                `${prefix}endDate`,
                `${prefix}reminderTime`
            ];

            if (formType === 'add') {
                requiredFields.push('patientSelect');
            }

            let isValid = true;

            requiredFields.forEach(field => {
                const element = $(`#${field}`);
                if (!element.val()) {
                    element.addClass('is-invalid');
                    isValid = false;
                } else {
                    element.removeClass('is-invalid');
                }
            });

            // Validate date range
            const startDate = new Date($(`#${prefix}StartDate`).val());
            const endDate = new Date($(`#${prefix}EndDate`).val());

            if (startDate > endDate) {
                $(`#${prefix}EndDate`).addClass('is-invalid');
                showToast('Error', 'End date must be after start date.', 'error');
                isValid = false;
            }

            return isValid;
        }

        // Function to show toast notification
        function showToast(title, message, type) {
            $('#toastTitle').text(title);
            $('#toastMessage').text(message);

            const toast = $('#notificationToast');

            // Set toast color based on type
            toast.removeClass('bg-success bg-danger bg-warning');
            switch(type) {
                case 'success':
                    toast.addClass('bg-success text-white');
                    break;
                case 'error':
                    toast.addClass('bg-danger text-white');
                    break;
                case 'warning':
                    toast.addClass('bg-warning');
                    break;
            }

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Sample data for demo purposes
        function getSamplePatients() {
            return [
                {
                    id: 1,
                    firstName: 'John',
                    lastName: 'Smith',
                    age: 45,
                    gender: 'Male',
                    dob: '1978-05-15',
                    medicalHistory: 'Hypertension, Diabetes'
                },
                {
                    id: 2,
                    firstName: 'Emily',
                    lastName: 'Johnson',
                    age: 32,
                    gender: 'Female',
                    dob: '1991-09-23',
                    medicalHistory: 'Asthma'
                },
                {
                    id: 3,
                    firstName: 'Michael',
                    lastName: 'Chen',
                    age: 56,
                    gender: 'Male',
                    dob: '1967-11-08',
                    medicalHistory: 'Heart Disease, Arthritis'
                },
                {
                    id: 4,
                    firstName: 'Sarah',
                    lastName: 'Williams',
                    age: 28,
                    gender: 'Female',
                    dob: '1995-03-17',
                    medicalHistory: 'Migraine'
                }
            ];
        }

        function getSampleMedications(patientId) {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);

            const nextMonth = new Date(today);
            nextMonth.setMonth(nextMonth.getMonth() + 1);

            const lastWeek = new Date(today);
            lastWeek.setDate(lastWeek.getDate() - 7);

            const lastMonth = new Date(today);
            lastMonth.setMonth(lastMonth.getMonth() - 1);

            // Format dates to YYYY-MM-DD
            const formatDate = (date) => {
                return date.toISOString().split('T')[0];
            };

            if (patientId == 1) {
                return [
                    {
                        id: 101,
                        patientId: 1,
                        medicationName: 'Lisinopril',
                        dosage: '10mg',
                        frequency: 'DAILY',
                        startDate: formatDate(lastMonth),
                        endDate: formatDate(nextMonth),
                        reminderTime: '08:00'
                    },
                    {
                        id: 102,
                        patientId: 1,
                        medicationName: 'Metformin',
                        dosage: '500mg',
                        frequency: 'TWICE_A_DAY',
                        startDate: formatDate(lastMonth),
                        endDate: formatDate(nextMonth),
                        reminderTime: '08:00'
                    },
                    {
                        id: 103,
                        patientId: 1,
                        medicationName: 'Aspirin',
                        dosage: '81mg',
                        frequency: 'DAILY',
                        startDate: formatDate(lastMonth),
                        endDate: formatDate(lastWeek),
                        reminderTime: '08:00'
                    }
                ];
            } else if (patientId == 2) {
                return [
                    {
                        id: 201,
                        patientId: 2,
                        medicationName: 'Albuterol',
                        dosage: '2 puffs',
                        frequency: 'TWICE_A_DAY',
                        startDate: formatDate(lastMonth),
                        endDate: formatDate(nextMonth),
                        reminderTime: '08:00'
                    },
                    {
                        id: 202,
                        patientId: 2,
                        medicationName: 'Fluticasone',
                        dosage: '1 puff',
                        frequency: 'DAILY',
                        startDate: formatDate(tomorrow),
                        endDate: formatDate(nextMonth),
                        reminderTime: '20:00'
                    }
                ];
            } else if (patientId == 3) {
                return [
                    {
                        id: 301,
                        patientId: 3,
                        medicationName: 'Atorvastatin',
                        dosage: '20mg',
                        frequency: 'DAILY',
                        startDate: formatDate(lastMonth),
                        endDate: formatDate(nextMonth),
                        reminderTime: '20:00'
                    },
                    {
                        id: 302,
                        patientId: 3,
                        medicationName: 'Ibuprofen',
                        dosage: '400mg',
                        frequency: 'TWICE_A_DAY',
                        startDate: formatDate(lastMonth),
                        endDate: formatDate(nextMonth),
                        reminderTime: '08:00'
                    },
                    {
                        id: 303,
                        patientId: 3,
                        medicationName: 'Vitamin D',
                        dosage: '1000 IU',
                        frequency: 'WEEKLY',
                        startDate: formatDate(lastMonth),
                        endDate: formatDate(nextMonth),
                        reminderTime: '08:00'
                    }
                ];
            } else if (patientId == 4) {
                return [
                    {
                        id: 401,
                        patientId: 4,
                        medicationName: 'Sumatriptan',
                        dosage: '50mg',
                        frequency: 'DAILY',
                        startDate: formatDate(lastMonth),
                        endDate: formatDate(nextMonth),
                        reminderTime: '08:00'
                    }
                ];
            }

            return [];
        }
    });
</script>
</body>
</html>
